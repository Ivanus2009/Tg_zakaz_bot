# Готовность проекта, .env и тесты

## Проект закончен?

**Да.** Реализовано:

- Telegram-бот (команды, кнопка «Открыть меню», приём заказов и оплата).
- Backend (FastAPI): меню из YTimes, заказы, подготовка платежа, создание заказа после оплаты, webhook статусов.
- Mini App (React в `frontend/`): в Docker собирается при сборке образа.
- Интеграция YTimes (меню, создание заказа).
- Оплата при получении и опционально «Оплатить онлайн» (Telegram Payments).
- Деплой: Docker Compose, nginx, certbot — описан в [DEPLOY.md](DEPLOY.md).

Доделывать код не нужно. Нужно только: развернуть на сервере, заполнить `.env` и при необходимости включить оплату онлайн.

---

## Будет ли бот сразу ходить на ваш домен?

**Да, после настройки .env на сервере.**

- В боте кнопка «Открыть меню» ведёт на `WEBAPP_URL` из `.env`.
- Если на сервере указать `WEBAPP_URL=https://palm-marten.ru`, то при нажатии откроется именно ваш домен (после получения SSL — HTTPS).
- До получения сертификатов можно временно использовать `http://85.239.38.41`, но Telegram **не открывает http** в Mini App — только https. Поэтому для бота нужен уже рабочий https (шаг 6 в DEPLOY.md).

Итого: поднимаете сервисы, получаете сертификаты, в `.env` ставите `WEBAPP_URL=https://palm-marten.ru` — бот сразу будет открывать ваше приложение по домену.

---

## Как «прикрутить» всё к своему приложению

1. **Скопировать проект на сервер** в `/opt/marten` (git clone или rsync/scp — см. DEPLOY.md, раздел 3).
2. **Создать на сервере `/opt/marten/.env`** и заполнить переменные (см. ниже).
3. **Первый запуск по HTTP** (раздел 5 DEPLOY.md): переименовать `https.conf`, затем `docker compose -f deploy/docker-compose.yml build && ... up -d`.
4. **Получить SSL** (раздел 6): certbot для palm-marten.ru, включить https.conf, reload nginx.
5. **В .env на сервере** выставить `WEBAPP_URL=https://palm-marten.ru`.

После этого бот и веб-приложение работают с вашим доменом; отдельно «прикручивать» домен в коде не нужно — достаточно .env и nginx (уже настроен в `deploy/nginx/`).

---

## Что обязательно добавить в .env (на сервере)

Скопировать из `example.env` и задать:

| Переменная | Обязательно | Пример / описание |
|------------|-------------|-------------------|
| `YT_API_KEY` | да | Ключ интеграции YTimes |
| `YT_SHOP_GUID` | да | GUID торговой точки |
| `TELEGRAM_BOT_TOKEN` | да | Токен от @BotFather |
| `WEBAPP_URL` | да | `https://palm-marten.ru` (без слэша в конце) |
| `BACKEND_URL` | да на VPS | `http://web:8000` (бот дергает API по имени сервиса) |
| `BOT_INTERNAL_SECRET` | да, если есть оплата онлайн | `openssl rand -hex 32` — один и тот же в .env |
| `PAYMENT_PROVIDER_TOKEN` | нет | Токен провайдера платежей (BotFather → Payments), иначе только «Оплата при получении» |

Итого для минимального продакшена: все строки выше, кроме `PAYMENT_PROVIDER_TOKEN`. Для онлайн-оплаты добавляете `BOT_INTERNAL_SECRET` и при необходимости `PAYMENT_PROVIDER_TOKEN`.

---

## Тесты приложения «от и до»

### 1. Проверка YTimes (меню, точки) — до запуска сервера

На машине, где есть `.env` с `YT_API_KEY` и `YT_SHOP_GUID`:

```bash
# из корня репо, в venv или окружении с установленными зависимостями
python scripts/check_api_response.py
```

Ожидается: список торговых точек, групп меню, позиций, добавок; результат пишется в `api_menu_data.json`. Ошибки — в stderr.

### 2. Проверка веб-приложения — после запуска (локально или на сервере)

Поднять приложение (локально: `uvicorn src.webapp.app:app --reload` или на сервере: `docker compose -f deploy/docker-compose.yml up -d`), затем:

```bash
# по умолчанию тестирует http://localhost:8000
python scripts/run_app_tests.py

# на продакшене
BASE_URL=https://palm-marten.ru python scripts/run_app_tests.py
```

Проверяется: `/health`, `/api/menu`, `/api/supplements`, главная страница `/`.

### 3. Ручные проверки после деплоя

- В браузере: `https://palm-marten.ru` — открывается приложение.
- В Telegram: открыть бота → /start → «Открыть меню» — открывается Mini App по вашему домену.
- Оформить тестовый заказ «Оплата при получении» — заказ должен появиться в YTimes и в боте.
- Если настроена онлайн-оплата: оформить заказ «Оплатить онлайн» — инвойс в Telegram, после оплаты заказ создаётся и платёж «очищается».

Итог: для работы приложения у вас всё есть; бот начнёт ходить на домен после деплоя и указания `WEBAPP_URL` в .env; «прикрутить» — это развернуть по DEPLOY.md и заполнить .env; тесты — `check_api_response.py` и `run_app_tests.py` плюс ручная проверка в браузере и в боте.
